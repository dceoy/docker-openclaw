x-common-build: &common-build
  context: .
  dockerfile: Dockerfile
  args: &common-build-args
    NODE_VERSION: ${CLAWDBOT_NODE_VERSION:-22}
    CLAWDBOT_VERSION: ${CLAWDBOT_VERSION:-latest}

x-common-environment: &common-environment
  HOME: /home/node
  TERM: xterm-256color
  CLAUDE_AI_SESSION_KEY: ${CLAUDE_AI_SESSION_KEY:-}
  CLAUDE_WEB_SESSION_KEY: ${CLAUDE_WEB_SESSION_KEY:-}
  CLAUDE_WEB_COOKIE: ${CLAUDE_WEB_COOKIE:-}
  OPENAI_API_KEY: ${OPENAI_API_KEY:-}
  ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:-}
  ELEVENLABS_API_KEY: ${ELEVENLABS_API_KEY:-}

x-common-volumes: &common-volumes
  - ${CLAWDBOT_CONFIG_DIR:-./.clawdbot}:/home/node/.clawdbot
  - ${CLAWDBOT_WORKSPACE_DIR:-./workspace}:/workspace

services:
  clawdbot-gateway:
    container_name: clawdbot-gateway
    build:
      <<: *common-build
      target: clawdbot
      platforms:
        - linux/amd64
        - linux/arm64
    image: ${CLAWDBOT_IMAGE:-clawdbot}:${CLAWDBOT_VERSION:-latest}
    hostname: clawdbot-gateway
    environment:
      <<: *common-environment
      NODE_ENV: production
    volumes: *common-volumes
    ports:
      - "${CLAWDBOT_GATEWAY_PORT:-18789}:18789"
      - "${CLAWDBOT_GATEWAY_WS_PORT:-18790}:18790"
    restart: unless-stopped
    command: ["clawdbot", "gateway", "--bind", "0.0.0.0"]

  clawdbot-cli:
    container_name: clawdbot-cli
    build:
      <<: *common-build
      target: clawdbot
    image: ${CLAWDBOT_IMAGE:-clawdbot}:${CLAWDBOT_VERSION:-latest}
    hostname: clawdbot-cli
    environment: *common-environment
    volumes: *common-volumes
    stdin_open: true
    tty: true
    profiles:
      - cli
    entrypoint: ["/usr/bin/tini", "--"]
    command: ["clawdbot"]

  clawdbot-sandbox:
    container_name: clawdbot-sandbox
    build:
      <<: *common-build
      target: clawdbot-sandbox
      args:
        <<: *common-build-args
        CLAWDBOT_DOCKER_APT_PACKAGES: ${CLAWDBOT_DOCKER_APT_PACKAGES:-}
    image: ${CLAWDBOT_IMAGE:-clawdbot}:${CLAWDBOT_VERSION:-latest}-sandbox
    hostname: clawdbot-sandbox
    environment:
      <<: *common-environment
      NODE_ENV: production
    volumes: *common-volumes
    ports:
      - "${CLAWDBOT_SANDBOX_PORT:-18791}:18789"
      - "${CLAWDBOT_SANDBOX_WS_PORT:-18792}:18790"
    restart: unless-stopped
    profiles:
      - sandbox
    command: ["clawdbot", "gateway", "--bind", "0.0.0.0"]

  clawdbot-browser:
    container_name: clawdbot-browser
    build:
      <<: *common-build
      target: clawdbot-browser
    image: ${CLAWDBOT_IMAGE:-clawdbot}:${CLAWDBOT_VERSION:-latest}-browser
    hostname: clawdbot-browser
    environment:
      <<: *common-environment
      NODE_ENV: production
      CHROME_PATH: /usr/bin/chromium
      PUPPETEER_EXECUTABLE_PATH: /usr/bin/chromium
      PUPPETEER_SKIP_CHROMIUM_DOWNLOAD: "true"
    volumes: *common-volumes
    ports:
      - "${CLAWDBOT_BROWSER_PORT:-18793}:18789"
      - "${CLAWDBOT_BROWSER_WS_PORT:-18794}:18790"
    restart: unless-stopped
    profiles:
      - browser
    security_opt:
      - seccomp=unconfined
    command: ["clawdbot", "gateway", "--bind", "0.0.0.0"]
